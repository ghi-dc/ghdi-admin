xquery version "3.1";

declare namespace output = "http://www.w3.org/2010/xslt-xquery-serialization";
declare namespace json="http://www.json.org";

declare namespace functx = "http://www.functx.com";
declare function functx:if-absent
  ( $arg as item()* ,
    $value as item()* )  as item()* {

    if (exists($arg))
    then $arg
    else $value
};

declare variable $collection external;
declare variable $locale external;
declare variable $q external;

(: Switch to JSON serialization :)
declare option output:method "json";
declare option output:media-type "text/javascript";

<json:value>
{
for $term in collection($collection)/CategoryCode{% if q is not empty %}[ft:query(*, $q)]{% endif %}
    let $name := functx:if-absent($term/name[@lang=$locale], $term/name[empty(@lang) or '_' = @lang])
    order by $name
    return <data json:array="true" id="{$term/@id}" gnd="{ $term/identifier[@propertyID='gnd'] }" lcauth="{ $term/identifier[@propertyID='lcauth'] }" wikidata="{ $term/identifier[@propertyID='wikidata'] }">
        <name>{$name/text()}</name>
    </data>
}
</json:value>
